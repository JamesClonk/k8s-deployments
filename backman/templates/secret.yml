#@ load("@ytt:data", "data")
#@ load("@ytt:base64", "base64")
#@ load("_ytt.lib.yml", "labels")

---
apiVersion: v1
kind: Secret
metadata:
  name: backman
  namespace: backman
  labels: #@ labels("secret")
  annotations:
    kapp.k14s.io/versioned: ""
type: Opaque
#@yaml/text-templated-strings
stringData:
  BACKMAN_USERNAME: #@ data.values.backman.username
  BACKMAN_PASSWORD: #@ data.values.backman.password
  PROBE_AUTHORIZATION: #@ 'Basic ' + base64.encode(data.values.backman.username + ':' + data.values.backman.password)
  BACKMAN_CONFIG: |
    {
      "log_level": "debug",
      "logging_timestamp": true,
      "unprotected_metrics": true,
      "s3": {
        "service_label": "user-provided",
        "service_name": "backman-storage",
        "bucket_name": "backman-storage"
      }
    }
  VCAP_APPLICATION: |
    {
      "application_id": "backman",
      "application_name": "backman",
      "application_uris": [
        "backman.backman.pod.cluster.local"
      ],
      "application_version": "(@= data.values.backman.image @)",
      "name": "backman",
      "organization_name": "backman",
      "space_name": "backman",
      "uris": [
        "backman.backman.pod.cluster.local"
      ],
      "version": "(@= data.values.backman.image @)"
    }
  VCAP_SERVICES: |
    {
      "user-provided": [{
        "credentials": {
            "region": "eu-west-1",
            "accessHost": "(@= data.values.backman.s3.host @)",
            "accessKey": "(@= data.values.backman.s3.key @)",
            "sharedSecret": "(@= data.values.backman.s3.secret @)"
        },
        "label": "user-provided",
        "name": "backman-storage"
      }
      (@- for db in data.values.backman.postgres: -@)
      , {
        "credentials": {
            "database": "(@= db.database @)",
            "database_uri": "(@= db.uri @)",
            "jdbcUrl": "(@= db.uri @)",
            "name": "(@= db.database @)",
            "uri": "(@= db.uri @)"
        },
        "label": "user-provided",
        "name": "(@= db.name @)"
      }
      (@- end -@)
      ]
    }
